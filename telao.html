<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tel√£o - CNV 2025 | Mar de Oportunidades</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* ============================================
       VARI√ÅVEIS CNV
       ============================================ */
    :root {
      --cnv-primary: #2797ff;
      --cnv-secondary: #0b67bc;
      --cnv-tertiary: #acc420;
      --cnv-alternate: #e0e3e7;
      --cnv-text-primary: #161c24;
      --cnv-accent-1: #222c3a;
      --cnv-success: #27ae52;
      --cnv-error: #ee4444;
      --cnv-warning: #fc964d;
    }

    /* ============================================
       ESTILO BASE
       ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      height: 100vh;
      position: relative;
      background: linear-gradient(180deg, #0b67bc 0%, #1a4d7a 50%, #222c3a 100%);
    }

    /* ============================================
       FUNDO OCE√ÇNICO ANIMADO
       ============================================ */
    .ocean-background {
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* Ondas animadas */
    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="%23acc420" fill-opacity="0.15"/></svg>') repeat-x;
      animation: wave-animation 25s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
      transform: translate3d(0, 0, 0);
    }

    .wave:nth-of-type(2) {
      bottom: -10px;
      animation: wave-animation 20s cubic-bezier(0.36, 0.45, 0.63, 0.53) -0.125s infinite, swell 7s ease -1.25s infinite;
      opacity: 0.8;
    }

    .wave:nth-of-type(3) {
      bottom: -20px;
      animation: wave-animation 30s cubic-bezier(0.36, 0.45, 0.63, 0.53) -0.25s infinite, swell 10s ease -2.5s infinite;
      opacity: 0.5;
    }

    @keyframes wave-animation {
      0% { transform: translate3d(-90px, 0, 0); }
      100% { transform: translate3d(85px, 0, 0); }
    }

    @keyframes swell {
      0%, 100% { transform: translate3d(0, -15px, 0); }
      50% { transform: translate3d(0, 5px, 0); }
    }

    /* Bolhas otimizadas */
    .bubbles {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .bubble {
      position: absolute;
      bottom: -100px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(172, 196, 32, 0.3));
      border-radius: 50%;
      opacity: 0.6;
      animation: rise 15s infinite ease-in;
      will-change: transform;
    }

    .bubble:nth-child(1) { width: 40px; height: 40px; left: 10%; animation-duration: 12s; animation-delay: 0s; }
    .bubble:nth-child(2) { width: 25px; height: 25px; left: 20%; animation-duration: 16s; animation-delay: 2s; }
    .bubble:nth-child(3) { width: 50px; height: 50px; left: 35%; animation-duration: 14s; animation-delay: 4s; }
    .bubble:nth-child(4) { width: 30px; height: 30px; left: 50%; animation-duration: 18s; animation-delay: 1s; }
    .bubble:nth-child(5) { width: 35px; height: 35px; left: 65%; animation-duration: 13s; animation-delay: 3s; }
    .bubble:nth-child(6) { width: 45px; height: 45px; left: 80%; animation-duration: 15s; animation-delay: 5s; }
    .bubble:nth-child(7) { width: 28px; height: 28px; left: 90%; animation-duration: 17s; animation-delay: 2s; }
    .bubble:nth-child(8) { width: 38px; height: 38px; left: 15%; animation-duration: 14s; animation-delay: 6s; }

    @keyframes rise {
      0% {
        bottom: -100px;
        transform: translateX(0) scale(0.8);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.6;
      }
      100% {
        bottom: 110vh;
        transform: translateX(20px) scale(1);
        opacity: 0;
      }
    }

    /* Raios de luz */
    .light-rays {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(172,196,32,0.03) 50%, transparent 70%);
      background-size: 200% 200%;
      animation: light-ray-animation 20s ease infinite;
    }

    @keyframes light-ray-animation {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }

    /* Mergulhador decorativo */
    .diver-container {
      position: absolute;
      top: 15%;
      right: 5%;
      width: 180px;
      height: 180px;
      opacity: 0.15;
      animation: float-diver 8s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
    }

    .diver-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes float-diver {
      0%, 100% { transform: translateY(0px) rotate(-5deg); }
      50% { transform: translateY(-30px) rotate(5deg); }
    }

    /* ============================================
       CONTE√öDO PRINCIPAL
       ============================================ */
    .main-container {
      position: relative;
      z-index: 10;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 3rem;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 2rem;
      animation: slideDown 0.8s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .event-title {
      font-size: clamp(2rem, 4vw, 3.5rem);
      font-weight: 800;
      color: white;
      text-shadow: 
        0 2px 10px rgba(0,0,0,0.3),
        0 0 30px rgba(172,196,32,0.4);
      margin-bottom: 1rem;
      letter-spacing: 2px;
    }

    .talk-info {
      display: inline-flex;
      align-items: center;
      gap: 1rem;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      padding: 1rem 2rem;
      border-radius: 50px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .speaker-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cnv-tertiary), var(--cnv-primary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .speaker-name {
      font-size: 1.5rem;
      color: white;
      font-weight: 600;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    /* Cards modernos */
    .content-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: 2rem;
      padding: 3rem;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.3),
        0 0 0 1px rgba(255,255,255,0.1) inset;
      animation: fadeInScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 1200px;
      width: 100%;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .badge-question {
      background: linear-gradient(135deg, var(--cnv-primary), var(--cnv-secondary));
      color: white;
    }

    .badge-poll {
      background: linear-gradient(135deg, var(--cnv-success), var(--cnv-tertiary));
      color: white;
    }

    .badge-quiz {
      background: linear-gradient(135deg, var(--cnv-warning), #ff9500);
      color: white;
    }

    /* Texto */
    .main-text {
      font-size: clamp(2rem, 4vw, 3.5rem);
      font-weight: 700;
      color: var(--cnv-text-primary);
      line-height: 1.3;
      margin-bottom: 2rem;
      text-align: center;
    }

    .sub-text {
      font-size: clamp(1.5rem, 2.5vw, 2rem);
      color: var(--cnv-accent-1);
      opacity: 0.7;
      text-align: center;
    }

    .call-to-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      font-size: 2rem;
      color: var(--cnv-primary);
      margin-top: 2rem;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    /* Countdown */
    .countdown-display {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 8px solid var(--cnv-primary);
      background: linear-gradient(135deg, rgba(39,151,255,0.1), rgba(172,196,32,0.1));
      margin: 2rem auto;
      box-shadow: 
        0 0 0 12px rgba(39,151,255,0.1),
        0 10px 30px rgba(0,0,0,0.2);
    }

    .countdown-number {
      font-size: 4rem;
      font-weight: 800;
      color: var(--cnv-primary);
      line-height: 1;
    }

    .countdown-label {
      font-size: 1rem;
      color: var(--cnv-accent-1);
      opacity: 0.7;
      margin-top: 0.5rem;
    }

    .countdown-urgent {
      border-color: var(--cnv-error);
      animation: pulse-urgent 0.5s ease-in-out infinite;
    }

    .countdown-urgent .countdown-number {
      color: var(--cnv-error);
    }

    @keyframes pulse-urgent {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 12px rgba(238,68,68,0.2); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 16px rgba(238,68,68,0.3); }
    }

    /* Loading */
    .loading-container {
      text-align: center;
    }

    .spinner {
      display: inline-block;
      width: 80px;
      height: 80px;
      border: 8px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 2rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    .footer {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      padding: 1.5rem;
      animation: slideUp 0.8s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .footer-badge {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      padding: 1rem 2rem;
      border-radius: 50px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .footer-text {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      letter-spacing: 1px;
    }

    /* Estados escondidos */
    .hidden {
      display: none !important;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .main-container {
        padding: 1.5rem;
      }
      
      .content-card {
        padding: 2rem;
      }

      .diver-container {
        width: 120px;
        height: 120px;
        top: 10%;
        right: 2%;
      }
    }

    /* Anima√ß√£o de entrada para √≠cones */
    .icon-bounce {
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* Performance: GPU acceleration */
    .content-card,
    .bubble,
    .wave,
    .diver-container {
      transform: translateZ(0);
      backface-visibility: hidden;
    }
  </style>
</head>

<body>
  <!-- Fundo Oce√¢nico -->
  <div class="ocean-background">
    <div class="light-rays"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="bubbles">
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
    </div>
  </div>

  <!-- Mergulhador Decorativo (SVG inline para n√£o depender de arquivo externo) -->
  <div class="diver-container">
    <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Corpo do mergulhador -->
      <ellipse cx="100" cy="80" rx="45" ry="55" fill="#2797ff"/>
      <path d="M70 80 Q65 100 55 115" stroke="#acc420" stroke-width="8" stroke-linecap="round" fill="none"/>
      <path d="M130 80 Q135 100 145 115" stroke="#acc420" stroke-width="8" stroke-linecap="round" fill="none"/>
      <ellipse cx="100" cy="50" rx="25" ry="28" fill="white" opacity="0.9"/>
      <circle cx="95" cy="48" r="8" fill="#0b67bc"/>
      <!-- Cilindro de oxig√™nio -->
      <rect x="85" y="85" width="30" height="45" rx="8" fill="#acc420"/>
      <rect x="90" y="88" width="6" height="38" rx="2" fill="#2797ff"/>
      <rect x="104" y="88" width="6" height="38" rx="2" fill="#2797ff"/>
      <!-- Bolhas -->
      <circle cx="110" cy="35" r="4" fill="white" opacity="0.6"/>
      <circle cx="120" cy="28" r="3" fill="white" opacity="0.5"/>
      <circle cx="115" cy="20" r="5" fill="white" opacity="0.4"/>
      <circle cx="125" cy="15" r="3" fill="white" opacity="0.3"/>
    </svg>
  </div>

  <!-- Container Principal -->
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <h1 class="event-title">
        üåä MAR DE OPORTUNIDADES
      </h1>
      <div class="talk-info">
        <div class="speaker-avatar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </div>
        <span id="speakerName" class="speaker-name">Aguardando palestrante...</span>
      </div>
    </header>

    <!-- Loading -->
    <div id="loading" class="content-area">
      <div class="loading-container">
        <div class="spinner"></div>
        <p class="sub-text" style="color: white;">Aguardando palestra ativa...</p>
      </div>
    </div>

    <!-- Conte√∫do Principal -->
    <main id="mainContent" class="content-area hidden">
      
      <!-- Modo: Vazio -->
      <div id="emptyMode" class="content-card">
        <div style="text-align: center;">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 2rem; color: rgba(0,0,0,0.2);">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="9" y1="10" x2="9" y2="10"></line>
            <line x1="15" y1="10" x2="15" y2="10"></line>
          </svg>
          <p class="main-text" style="color: rgba(0,0,0,0.4);">
            Aguardando conte√∫do...
          </p>
          <p class="sub-text">
            O conte√∫do ser√° exibido em breve
          </p>
        </div>
      </div>

      <!-- Modo: Pergunta -->
      <div id="questionMode" class="hidden">
        <div class="content-card">
          <div class="badge badge-question">
            <span>üí¨</span>
            <span>PERGUNTA</span>
          </div>
          
          <p id="questionText" class="main-text"></p>
          
          <div id="questionAuthor" class="sub-text"></div>
        </div>
      </div>

      <!-- Modo: Enquete -->
      <div id="pollMode" class="hidden">
        <div class="content-card">
          <div class="badge badge-poll">
            <span>üìä</span>
            <span>ENQUETE ATIVA</span>
          </div>
          
          <h2 id="pollTitle" class="main-text"></h2>
          
          <div class="call-to-action">
            <span class="icon-bounce">üì±</span>
            <span>Vote no seu dispositivo!</span>
          </div>
        </div>
      </div>

      <!-- Modo: Quiz - Pergunta -->
      <div id="quizQuestionMode" class="hidden">
        <div class="content-card">
          <div class="badge badge-quiz">
            <span>üéÆ</span>
            <span id="quizProgress">QUIZ</span>
          </div>
          
          <p id="quizQuestionText" class="main-text"></p>
          
          <div id="quizCountdownContainer"></div>
          
          <div class="call-to-action">
            <span class="icon-bounce">üì±</span>
            <span>Responda no seu dispositivo!</span>
          </div>
        </div>
      </div>

      <!-- Modo: Quiz - Resultado -->
      <div id="quizResultMode" class="hidden">
        <div class="content-card">
          <div class="badge badge-quiz">
            <span>üéÆ</span>
            <span>RESULTADO</span>
          </div>
          
          <div style="text-align: center; margin-bottom: 2rem;">
            <p class="sub-text" style="margin-bottom: 1rem;">Resposta Correta:</p>
            <p id="correctAnswer" class="main-text" style="color: var(--cnv-success);"></p>
          </div>
          
          <div style="margin-bottom: 2rem;">
            <canvas id="chartQuizDisplay" height="200"></canvas>
          </div>
          
          <div style="text-align: center;">
            <p id="accuracyPercentage" class="main-text" style="color: var(--cnv-primary);"></p>
          </div>
        </div>
      </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-badge">
        <p class="footer-text">CNV 2025</p>
      </div>
      <div class="footer-badge">
        <p class="footer-text">üöÄ by TUNAP Labs</p>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="js/supabase-config.js"></script>
  <script src="js/enquetes-quiz-utils.js"></script>
  <script>
    // ============================================
    // SISTEMA DE GERENCIAMENTO DO TEL√ÉO
    // ============================================
    
    let currentMode = 'loading';
    let quizCountdown = null;

    // Elementos do DOM
    const elements = {
      loading: document.getElementById('loading'),
      mainContent: document.getElementById('mainContent'),
      speakerName: document.getElementById('speakerName'),
      emptyMode: document.getElementById('emptyMode'),
      questionMode: document.getElementById('questionMode'),
      pollMode: document.getElementById('pollMode'),
      quizQuestionMode: document.getElementById('quizQuestionMode'),
      quizResultMode: document.getElementById('quizResultMode'),
      questionText: document.getElementById('questionText'),
      questionAuthor: document.getElementById('questionAuthor'),
      pollTitle: document.getElementById('pollTitle'),
      quizProgress: document.getElementById('quizProgress'),
      quizQuestionText: document.getElementById('quizQuestionText'),
      quizCountdownContainer: document.getElementById('quizCountdownContainer'),
      correctAnswer: document.getElementById('correctAnswer'),
      accuracyPercentage: document.getElementById('accuracyPercentage'),
      chartQuizDisplay: document.getElementById('chartQuizDisplay')
    };

    // Ocultar loading e mostrar conte√∫do
    // Utilit√°rios visuais
    function showContent(){ elements.loading.classList.add('hidden'); elements.mainContent.classList.remove('hidden'); }
    function hideAllModes(){
      elements.emptyMode.classList.add('hidden');
      elements.questionMode.classList.add('hidden');
      elements.pollMode.classList.add('hidden');
      elements.quizQuestionMode.classList.add('hidden');
      elements.quizResultMode.classList.add('hidden');
    }
    function showMode(key){ hideAllModes(); elements[key]?.classList.remove('hidden'); }

    // ============================================
    // MODO: VAZIO
    // ============================================
    function displayEmptyMode(){ showContent(); showMode('emptyMode'); currentMode='empty'; }
    function displayPoll(poll){ showContent(); showMode('pollMode'); elements.pollTitle.textContent = poll.titulo || 'Enquete'; currentMode='poll'; }
    function displayPollResult(poll, resultado){
      showContent(); showMode('pollMode'); // reaproveitando card de enquete
      elements.pollTitle.textContent = `Resultados ‚Äî ${poll.titulo}`;
      // voc√™ pode enriquecer aqui com barras/progresso no futuro
    }

    // ============================================
    // BROADCAST GLOBAL (sem palestra)
    // ============================================
    let broadcast = { enquete_ativa: null, mostrar_resultado_enquete: false };
    let canalBroadcast = null;
  
    async function carregarBroadcast(){
      const { data, error } = await supabase
        .from('cnv25_broadcast_controle')
        .select('enquete_ativa, mostrar_resultado_enquete')
        .eq('id', 1)
        .single();
      if (error) { console.error(error); displayEmptyMode(); return; }
      broadcast.enquete_ativa = data?.enquete_ativa || null;
      broadcast.mostrar_resultado_enquete = !!data?.mostrar_resultado_enquete;
      decidirOQueExibir();
    }
  
    function conectarRealtimeBroadcast(){
      if (canalBroadcast) return;
      canalBroadcast = supabase
        .channel('telao_broadcast')
        .on('postgres_changes', {
          event: '*', schema: 'public', table: 'cnv25_broadcast_controle', filter: 'id=eq.1'
        }, (payload) => {
          broadcast.enquete_ativa = payload.new?.enquete_ativa || null;
          broadcast.mostrar_resultado_enquete = !!payload.new?.mostrar_resultado_enquete;
          decidirOQueExibir();
        })
        .subscribe();
    }
  
    // ============================================
    // CARREGAMENTO DE ENQUETE/RESULTADO
    // ============================================
    async function fetchEnquete(enqueteId){
      const { data, error } = await supabase
        .from('cnv25_enquetes')
        .select('*')
        .eq('id', enqueteId)
        .single();
      if (error) { console.error(error); return null; }
      return data;
    }
  
    async function fetchResultadoEnquete(enqueteId){
      // Tenta view agregada; fallback simples
      let viaView = true;
      const r1 = await supabase
        .from('cnv25_enquete_resultado_v') // se n√£o existir, cai no catch
        .select('*')
        .eq('enquete_id', enqueteId);
      if (r1.error) viaView = false;
  
      if (viaView){
        return { via:'view', rows: r1.data || [] };
      } else {
        const { data: rs, error } = await supabase
          .from('cnv25_enquete_respostas')
          .select('resposta')
          .eq('enquete_id', enqueteId);
        if (error) { console.error(error); return { via:'none', rows: [] }; }
        const cont = {};
        (rs||[]).forEach(r=>{
          const idx = parseInt(r.resposta?.opcaoIndex ?? r.resposta?.opcao_index ?? 0, 10) || 0;
          cont[idx] = (cont[idx]||0)+1;
        });
        const rows = Object.entries(cont).map(([k,v])=>({ opcao_index: parseInt(k,10), votos: v }));
        return { via:'client', rows };
      }
    }
  
    // ============================================
    // DECISOR DO TEL√ÉO
    // ============================================
    async function decidirOQueExibir(){
      // Por enquanto s√≥ orquestramos Enquetes via broadcast; Quiz vem depois
      if (!broadcast.enquete_ativa){
        displayEmptyMode();
        return;
      }
  
      // Tem enquete ativa
      const enquete = await fetchEnquete(broadcast.enquete_ativa);
      if (!enquete){ displayEmptyMode(); return; }
  
      if (broadcast.mostrar_resultado_enquete){
        const resultado = await fetchResultadoEnquete(enquete.id);
        displayPollResult(enquete, resultado);
      } else {
        displayPoll(enquete);
      }
    }

    // ============================================
    // MODO: QUIZ
    // ============================================
    function displayQuiz(quizData) {
      showContent();
      
      const { pergunta_atual, total_perguntas, pergunta, revelada, tempo_limite } = quizData;
      
      elements.quizProgress.textContent = `QUIZ - Pergunta ${pergunta_atual}/${total_perguntas}`;
      
      if (revelada) {
        // Mostrar resultado
        showMode('quizResultMode');
        displayQuizResult(quizData);
      } else {
        // Mostrar pergunta
        showMode('quizQuestionMode');
        elements.quizQuestionText.textContent = pergunta;
        
        // Countdown
        startQuizCountdown(tempo_limite || 30);
      }
      
      currentMode = 'quiz';
    }

    // Countdown do Quiz
    function startQuizCountdown(duration) {
      // Limpar countdown anterior
      if (quizCountdown) {
        clearInterval(quizCountdown);
      }
      
      let timeLeft = duration;
      
      // Criar HTML do countdown
      elements.quizCountdownContainer.innerHTML = `
        <div class="countdown-display" id="countdownCircle">
          <div class="countdown-number" id="countdownNumber">${timeLeft}</div>
          <div class="countdown-label">segundos</div>
        </div>
      `;
      
      const countdownCircle = document.getElementById('countdownCircle');
      const countdownNumber = document.getElementById('countdownNumber');
      
      // Iniciar countdown
      quizCountdown = setInterval(() => {
        timeLeft--;
        countdownNumber.textContent = timeLeft;
        
        // Adicionar urg√™ncia nos √∫ltimos 10 segundos
        if (timeLeft <= 10 && timeLeft > 5) {
          countdownCircle.classList.add('countdown-urgent');
        }
        
        // Parar quando chegar a zero
        if (timeLeft <= 0) {
          clearInterval(quizCountdown);
          countdownNumber.textContent = '‚è∞';
          countdownCircle.style.borderColor = 'var(--cnv-error)';
          countdownCircle.style.backgroundColor = 'rgba(238,68,68,0.1)';
        }
      }, 1000);
    }

    // Resultado do Quiz
    function displayQuizResult(quizData) {
      const { respostas, resposta_correta } = quizData;
      
      // Exibir resposta correta
      elements.correctAnswer.textContent = resposta_correta || 'N/A';
      
      // Calcular percentual de acerto (simula√ß√£o - adaptar conforme sua l√≥gica)
      const totalRespostas = respostas ? respostas.length : 0;
      const acertos = respostas ? respostas.filter(r => r.correta).length : 0;
      const percentual = totalRespostas > 0 ? Math.round((acertos / totalRespostas) * 100) : 0;
      
      elements.accuracyPercentage.textContent = `${percentual}% de acerto`;
      
      // Gr√°fico (adaptar conforme seus dados)
      if (window.Chart && elements.chartQuizDisplay) {
        new Chart(elements.chartQuizDisplay, {
          type: 'bar',
          data: {
            labels: ['A', 'B', 'C', 'D'],
            datasets: [{
              label: 'Votos',
              data: [12, 19, 8, 25], // Dados de exemplo
              backgroundColor: [
                'rgba(39, 151, 255, 0.8)',
                'rgba(172, 196, 32, 0.8)',
                'rgba(252, 150, 77, 0.8)',
                'rgba(39, 174, 82, 0.8)'
              ],
              borderColor: [
                'rgba(39, 151, 255, 1)',
                'rgba(172, 196, 32, 1)',
                'rgba(252, 150, 77, 1)',
                'rgba(39, 174, 82, 1)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    // ============================================
    // BOOT
    // ============================================
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('üåä Tel√£o Mar de Oportunidades iniciado!');
      // Header palestrante era atrelado √† palestra; como desacoplamos, mant√©m neutro:
      elements.speakerName.textContent = '‚Äî';
      displayEmptyMode();
  
      await carregarBroadcast();
      conectarRealtimeBroadcast();
  
      console.log('üí° Tel√£o ouvindo broadcast global (enquete/resultado).');
    });
  </script>
</body>
</html>
