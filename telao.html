<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="stylesheet" href="css/cnv-colors.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TelÃ£o - CNV 2025</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #222c3a 0%, #0b67bc 100%);
      min-height: 100vh;
      overflow: hidden;
    }
    
    .pergunta-atual {
      font-size: clamp(2rem, 5vw, 4rem);
      line-height: 1.3;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .proxima-preview {
      font-size: clamp(1rem, 2.5vw, 1.5rem);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .palestrante-badge {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
    }
  </style>
</head>
<body class="flex flex-col p-6">
  
  <!-- Header -->
  <header class="text-center mb-8">
    <h1 id="palestraTitulo" class="text-3xl md:text-5xl font-bold text-white drop-shadow-lg mb-3">
      Carregando...
    </h1>
    <!-- Badge do Palestrante -->
    <div class="inline-flex items-center gap-2 palestrante-badge px-6 py-3 rounded-full">
      <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path>
      </svg>
      <span id="palestrante" class="text-xl text-white font-semibold">
        <!-- Nome do palestrante -->
      </span>
    </div>
  </header>
  
  <!-- Loading -->
  <div id="loading" class="flex-1 flex items-center justify-center">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-white mb-4"></div>
      <p class="text-2xl text-white">Aguardando palestra ativa...</p>
    </div>
  </div>
  
  <!-- Pergunta Principal -->
  <main id="containerPergunta" class="flex-1 flex items-center justify-center px-4 hidden">
    <div class="w-full max-w-6xl">
      
      <!-- Sem Pergunta -->
      <div id="semPergunta">
        <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-16 border-2 border-white/20">
          <svg class="w-32 h-32 mx-auto mb-6 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
          <p class="text-3xl text-white/70 font-semibold text-center">
            Aguardando perguntas...
          </p>
        </div>
      </div>
      
      <!-- Com Pergunta -->
      <div id="comPergunta" class="hidden">
        <!-- Label -->
        <div class="mb-4">
          <span class="inline-block bg-white/20 text-white px-6 py-2 rounded-full text-lg font-semibold backdrop-blur-sm">
            ðŸ“Œ PERGUNTA
          </span>
        </div>
        
        <!-- Card da Pergunta -->
        <div class="bg-white rounded-3xl shadow-2xl p-12 mb-8 fade-in">
          <p id="textoPergunta" class="pergunta-atual text-gray-800 font-bold text-center mb-6">
            <!-- SerÃ¡ preenchido -->
          </p>
          <div id="nomePergunta" class="text-center text-gray-600 text-2xl">
            <!-- Nome ou AnÃ´nimo -->
          </div>
        </div>
      </div>
      
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="text-center">
    <div class="inline-block bg-white/10 backdrop-blur-sm rounded-full px-8 py-3">
      <p class="text-white text-lg">
        <strong>CNV 2025</strong>
      </p>
    </div>
  </footer>
  
  <!-- Scripts -->
  <script src="js/supabase-config.js"></script>
  <script>
    let palestraId = null;
    let palestra = null;
    let perguntaAtual = null;
    let proximaPergunta = null;
    let canalPalestraAtiva = null;
    let canalPalestra = null;
    
    async function inicializar() {
      console.log('ðŸ–¥ï¸ TelÃ£o inicializando...');
      await conectarRealtimePalestraAtiva();
      await carregarPalestraAtiva();
    }
    
    function conectarRealtimePalestraAtiva() {
      canalPalestraAtiva = supabase
        .channel('palestra_ativa_telao')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'cnv25_palestra_ativa',
          filter: 'id=eq.1'
        }, async (payload) => {
          console.log('ðŸ”„ Palestra mudou:', payload);
          if (payload.new.palestra_id !== palestraId) {
            await carregarPalestraAtiva();
          }
        })
        .subscribe();
    }
    
    async function carregarPalestraAtiva() {
      try {
        const { data: palestraAtiva } = await supabase
          .from('cnv25_palestra_ativa')
          .select('palestra_id')
          .eq('id', 1)
          .single();
        
        const novaPalestraId = palestraAtiva?.palestra_id;
        
        if (!novaPalestraId) {
          mostrarLoading();
          return;
        }
        
        if (canalPalestra && palestraId !== novaPalestraId) {
          window.supabase.removeChannel(canalPalestra);
          canalPalestra = null;
        }
        
        palestraId = novaPalestraId;
        
        const { data: palestraData } = await supabase
          .from('cnv25_palestras')
          .select('*')
          .eq('id', palestraId)
          .single();
        
        palestra = palestraData;
        
        // Atualizar header COM PALESTRANTE
        document.getElementById('palestraTitulo').textContent = palestra.titulo;
        document.getElementById('palestrante').textContent = palestra.palestrante || 'Palestrante nÃ£o definido';
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('containerPergunta').classList.remove('hidden');
        
        await carregarPerguntaAtual();
        conectarRealtimePalestra();
        
      } catch (error) {
        console.error('Erro:', error);
        mostrarLoading();
      }
    }
    
    function conectarRealtimePalestra() {
      if (canalPalestra) return;
      
      canalPalestra = supabase
        .channel(`telao:${palestraId}`)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'cnv25_perguntas',
          filter: `palestra_id=eq.${palestraId}`
        }, async (payload) => {
          console.log('ðŸ“¢ Pergunta atualizada:', payload);
          
          const pergunta = payload.new;
          
          if (pergunta.status === 'exibida') {
            perguntaAtual = pergunta;
            await atualizarProxima();
            renderizarPergunta();
          }
          
          if (perguntaAtual && pergunta.id === perguntaAtual.id && pergunta.status === 'respondida') {
            perguntaAtual = null;
            await atualizarProxima();
            renderizarPergunta();
          }
          
          if (pergunta.status === 'aprovada') {
            await atualizarProxima();
            renderizarPergunta();
          }
        })
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'cnv25_perguntas',
          filter: `palestra_id=eq.${palestraId}`
        }, async (payload) => {
          if (payload.new.status === 'aprovada' && !proximaPergunta) {
            await atualizarProxima();
            renderizarPergunta();
          }
        })
        .subscribe();
    }
    
    async function carregarPerguntaAtual() {
      try {
        const { data: exibida } = await supabase
          .from('cnv25_perguntas')
          .select('*')
          .eq('palestra_id', palestraId)
          .eq('status', 'exibida')
          .single();
        
        perguntaAtual = exibida || null;
        await atualizarProxima();
        renderizarPergunta();
        
      } catch (error) {
        console.error('Erro:', error);
      }
    }
    
    async function atualizarProxima() {
      try {
        const { data } = await supabase
          .from('cnv25_perguntas')
          .select('*')
          .eq('palestra_id', palestraId)
          .eq('status', 'aprovada')
          .order('created_at', { ascending: true })
          .limit(1);
        
        proximaPergunta = (data && data.length > 0) ? data[0] : null;
        
      } catch (error) {
        console.error('Erro:', error);
      }
    }
    
    function renderizarPergunta() {
      const semPergunta = document.getElementById('semPergunta');
      const comPergunta = document.getElementById('comPergunta');
      const textoPergunta = document.getElementById('textoPergunta');
      const nomePergunta = document.getElementById('nomePergunta');
      const containerProxima = document.getElementById('containerProxima');
      const textoProxima = document.getElementById('textoProxima');
      
      if (!perguntaAtual) {
        semPergunta.classList.remove('hidden');
        comPergunta.classList.add('hidden');
        return;
      }
      
      semPergunta.classList.add('hidden');
      comPergunta.classList.remove('hidden');
      comPergunta.classList.add('fade-in');
      
      textoPergunta.textContent = perguntaAtual.texto;
      
      if (perguntaAtual.anonimo) {
        nomePergunta.innerHTML = 'ðŸ‘¤ <em>AnÃ´nimo</em>';
      } else {
        nomePergunta.innerHTML = `ðŸ‘¤ ${escapeHtml(perguntaAtual.nome_opt)}`;
      }
      
      if (proximaPergunta) {
        containerProxima.classList.remove('hidden');
        textoProxima.textContent = proximaPergunta.texto;
      } else {
        containerProxima.classList.add('hidden');
      }
    }
    
    function mostrarLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('containerPergunta').classList.add('hidden');
      document.getElementById('palestraTitulo').textContent = 'Aguardando palestra ativa...';
      document.getElementById('palestrante').textContent = '';
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    window.addEventListener('DOMContentLoaded', inicializar);
    
    window.addEventListener('beforeunload', () => {
      if (canalPalestraAtiva) window.supabase.removeChannel(canalPalestraAtiva);
      if (canalPalestra) window.supabase.removeChannel(canalPalestra);
    });
    
    console.log('âœ… TelÃ£o carregado');
  </script>
  
</body>
</html>
